#!/bin/sh

# Exit immediately if any command fails
set -e

REPO_ROOT=$(git rev-parse --show-toplevel)

echo "üîç Running pre-commit checks..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only)

# Check if plugin files are staged
if echo "$STAGED_FILES" | grep -q "^plugin/"; then
    echo "\nüì¶ Checking Plugin..."
    cd "$REPO_ROOT/plugin"
    
    # Auto-fix formatting and linting
    echo "  Formatting..."
    npm run format
    
    echo "  Linting..."
    npm run lint:fix
    
    # Run full check (format:check, lint, type-check)
    echo "  Running checks..."
    npm run check
    
    echo "‚úÖ Plugin checks passed!"
    
    # Re-stage only plugin files that were originally staged
    cd "$REPO_ROOT"
    PLUGIN_FILES=$(echo "$STAGED_FILES" | grep "^plugin/" || true)
    if [ -n "$PLUGIN_FILES" ]; then
        echo "$PLUGIN_FILES" | xargs git add
    fi
else
    echo "\n‚è≠Ô∏è  No plugin files staged, skipping plugin checks"
fi

# Check if daemon files are staged
if echo "$STAGED_FILES" | grep -q "^daemon/"; then
    echo "\nü§ñ Checking Daemon..."
    cd "$REPO_ROOT/daemon"
    
    # Auto-fix formatting and linting
    echo "  Formatting..."
    npm run format
    
    echo "  Linting..."
    npm run lint:fix
    
    # Run full check (format:check, lint, type-check, tests)
    echo "  Running checks..."
    npm run check
    
    echo "‚úÖ Daemon checks passed!"
    
    # Re-stage only daemon files that were originally staged
    cd "$REPO_ROOT"
    DAEMON_FILES=$(echo "$STAGED_FILES" | grep "^daemon/" || true)
    if [ -n "$DAEMON_FILES" ]; then
        echo "$DAEMON_FILES" | xargs git add
    fi
else
    echo "\n‚è≠Ô∏è  No daemon files staged, skipping daemon checks"
fi

echo "\n‚úÖ All pre-commit checks passed!"
echo "üöÄ Proceeding with commit..."

