#!/bin/sh

# Exit immediately if any command fails
set -e

REPO_ROOT=$(git rev-parse --show-toplevel)

echo "üîç Running pre-commit checks..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only)

# Check if plugin files are staged
if echo "$STAGED_FILES" | grep -q "^plugin/"; then
    echo "\nüì¶ Checking Plugin..."
    cd "$REPO_ROOT/plugin"
    
    # Auto-fix formatting and linting
    echo "  Formatting..."
    npm run format
    
    echo "  Linting..."
    npm run lint:fix
    
    # Run full check (format:check, lint, type-check)
    echo "  Running checks..."
    npm run check
    
    echo "‚úÖ Plugin checks passed!"
    
    # Re-stage plugin files (git add -u handles both modified and deleted files)
    cd "$REPO_ROOT"
    git add -u plugin/
else
    echo "\n‚è≠Ô∏è  No plugin files staged, skipping plugin checks"
fi

# Check if daemon files are staged
if echo "$STAGED_FILES" | grep -q "^daemon/"; then
    echo "\nü§ñ Checking Daemon..."
    cd "$REPO_ROOT/daemon"
    
    # Auto-fix formatting and linting
    echo "  Formatting..."
    npm run format
    
    echo "  Linting..."
    npm run lint:fix
    
    # Run full check (format:check, lint, type-check, tests)
    echo "  Running checks..."
    npm run check
    
    echo "‚úÖ Daemon checks passed!"
    
    # Re-stage daemon files (git add -u handles both modified and deleted files)
    cd "$REPO_ROOT"
    git add -u daemon/
else
    echo "\n‚è≠Ô∏è  No daemon files staged, skipping daemon checks"
fi

echo "\n‚úÖ All pre-commit checks passed!"
echo "üöÄ Proceeding with commit..."
