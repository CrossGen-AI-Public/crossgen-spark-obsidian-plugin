#!/bin/sh

# Exit immediately if any command fails
set -e

REPO_ROOT=$(git rev-parse --show-toplevel)

echo "üîç Running pre-commit checks..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only)

# Check if plugin files are staged
STAGED_PLUGIN_FILES=$(echo "$STAGED_FILES" | grep "^plugin/" || true)
if [ -n "$STAGED_PLUGIN_FILES" ]; then
    echo "\nüì¶ Checking Plugin..."
    cd "$REPO_ROOT/plugin"
    
    # Auto-fix formatting and linting
    echo "  Formatting..."
    npm run format
    
    echo "  Linting..."
    npm run lint:fix
    
    # Run full check (format:check, lint, type-check)
    echo "  Running checks..."
    npm run check
    
    echo "‚úÖ Plugin checks passed!"
    
    # Re-stage ONLY the originally staged plugin files (not all modified files)
    cd "$REPO_ROOT"
    echo "$STAGED_PLUGIN_FILES" | while read -r file; do
        [ -n "$file" ] && git add "$file"
    done
else
    echo "\n‚è≠Ô∏è  No plugin files staged, skipping plugin checks"
fi

# Check if engine files are staged
STAGED_ENGINE_FILES=$(echo "$STAGED_FILES" | grep "^engine/" || true)
if [ -n "$STAGED_ENGINE_FILES" ]; then
    echo "\nü§ñ Checking Engine..."
    cd "$REPO_ROOT/engine"
    
    # Auto-fix formatting and linting
    echo "  Formatting..."
    npm run format
    
    echo "  Linting..."
    npm run lint:fix
    
    # Run full check (format:check, lint, type-check, tests)
    echo "  Running checks..."
    npm run check
    
    echo "‚úÖ Engine checks passed!"
    
    # Re-stage ONLY the originally staged engine files (not all modified files)
    cd "$REPO_ROOT"
    echo "$STAGED_ENGINE_FILES" | while read -r file; do
        [ -n "$file" ] && git add "$file"
    done
else
    echo "\n‚è≠Ô∏è  No engine files staged, skipping engine checks"
fi

echo "\n‚úÖ All pre-commit checks passed!"
echo "üöÄ Proceeding with commit..."
